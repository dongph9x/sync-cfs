---
import Layout from "../../layouts/Layout.astro";
import { requireRole } from "../../lib/session";
import { createPool, getAllChannels, getThreadsByChannelId } from "../../lib/db";
import type { Channel, Thread } from "../../lib/db";
import ViewerPanel from "../../components/ViewerPanel.tsx";

// Require viewer role
await requireRole(Astro, ['viewer', 'editor', 'admin']);

// Initialize database
createPool({
  host: import.meta.env.MYSQL_HOST || 'localhost',
  port: parseInt(import.meta.env.MYSQL_PORT || '3306'),
  user: import.meta.env.MYSQL_USER || 'root',
  password: import.meta.env.MYSQL_PASSWORD || '',
  database: import.meta.env.MYSQL_DATABASE || 'forum'
});

// Get all channels and their threads
const channels = await getAllChannels();
const channelThreads: { channel: Channel; threads: Thread[] }[] = [];

for (const channel of channels) {
  const threads = await getThreadsByChannelId(channel.id);
  channelThreads.push({
    channel: channel,
    threads: threads
  });
}

// SEO
const seo = {
  title: "Quản Trị - Viewer",
  description: "Trang quản trị cho viewer - Xem threads",
  keywords: ["quản trị", "viewer", "threads", "forum"],
  canonical: `${Astro.site}viewer/`,
};
---

<Layout seo={seo}>
  <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
    <div class="mb-2">
      <h1 class="text-3xl font-bold text-gray-900">Quản Trị - Viewer</h1>
      <p class="mt-2 text-gray-600">Xem và quản lý threads trong các kênh (Chỉ xem)</p>
    </div>

    <ViewerPanel client:load channels={channels as any} channelThreads={channelThreads as any} />
  </div>
</Layout>
