---
import Layout from "../../layouts/Layout.astro";
import { createPool, getAllChannels, type Channel } from "../../lib/db";

// Initialize database connection
const dbConfig = {
    host: import.meta.env.MYSQL_HOST || "localhost",
    port: parseInt(import.meta.env.MYSQL_PORT || "3306"),
    user: import.meta.env.MYSQL_USER || "root",
    password: import.meta.env.MYSQL_PASSWORD || "password",
    database: import.meta.env.MYSQL_DATABASE || "forum",
};

createPool(dbConfig);

// Fetch channels data
let channels: Channel[] = [];
try {
    channels = await getAllChannels();
} catch (error) {
    console.error("Failed to fetch channels:", error);
}

const seo = {
    title: "Kênh Diễn Đàn - Cộng Đồng Discord",
    description:
        "Duyệt qua tất cả các kênh diễn đàn trong cộng đồng Discord của chúng tôi. Tìm thảo luận về nhiều chủ đề khác nhau và tham gia cuộc trò chuyện.",
    keywords: ["diễn đàn", "kênh", "discord", "cộng đồng", "thảo luận"],
    canonical: `${Astro.site}forum/`,
};
---

<Layout seo={seo}>
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
        <!-- Breadcrumb -->
        <nav class="flex mb-8" aria-label="Breadcrumb">
            <ol class="inline-flex items-center space-x-1 md:space-x-3">
                <li class="inline-flex items-center">
                    <a
                        href="/"
                        class="inline-flex items-center text-sm font-medium text-stack-gray-700 hover:text-stack-blue"
                    >
                        <svg
                            class="w-4 h-4 mr-2"
                            fill="currentColor"
                            viewBox="0 0 20 20"
                        >
                            <path
                                d="M10.707 2.293a1 1 0 00-1.414 0l-7 7a1 1 0 001.414 1.414L4 10.414V17a1 1 0 001 1h2a1 1 0 001-1v-2a1 1 0 011-1h2a1 1 0 011 1v2a1 1 0 001 1h2a1 1 0 001-1v-6.586l.293.293a1 1 0 001.414-1.414l-7-7z"
                            ></path>
                        </svg>
                        Trang Chủ
                    </a>
                </li>
                <li>
                    <div class="flex items-center">
                        <svg
                            class="w-6 h-6 text-stack-gray-400"
                            fill="currentColor"
                            viewBox="0 0 20 20"
                        >
                            <path
                                fill-rule="evenodd"
                                d="M7.293 14.707a1 1 0 010-1.414L10.586 10 7.293 6.707a1 1 0 011.414-1.414l4 4a1 1 0 010 1.414l-4 4a1 1 0 01-1.414 0z"
                                clip-rule="evenodd"></path>
                        </svg>
                        <span
                            class="ml-1 text-sm font-medium text-stack-gray-500 md:ml-2"
                            >Diễn Đàn</span
                        >
                    </div>
                </li>
            </ol>
        </nav>

        <!-- Header -->
        <div class="mb-8 text-center">
            <h1 class="text-3xl font-bold text-stack-gray-900 mb-4">
                Kênh Diễn Đàn
            </h1>
            <p class="text-lg text-stack-gray-600 mb-6">
                Duyệt qua các thảo luận được tổ chức theo chủ đề. Mỗi kênh chứa các chủ đề và cuộc trò chuyện từ cộng đồng Discord của chúng tôi.
            </p>

            <!-- Quick Search Link -->
            <div class="max-w-md mx-auto">
                <a
                    href="/search/"
                    class="inline-flex items-center w-full px-4 py-3 border border-gray-300 rounded-lg bg-white text-left text-gray-500 hover:bg-gray-50 hover:border-blue-300 transition-colors group"
                >
                    <svg
                        class="w-5 h-5 mr-3 text-gray-400 group-hover:text-blue-500"
                        fill="none"
                        stroke="currentColor"
                        viewBox="0 0 24 24"
                    >
                        <path
                            stroke-linecap="round"
                            stroke-linejoin="round"
                            stroke-width="2"
                            d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"
                        ></path>
                    </svg>
                    Tìm kiếm chủ đề và bài viết diễn đàn...
                </a>
            </div>
        </div>

        <!-- Stats Summary -->
        <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-8">
            <div class="card">
                <div class="card-body text-center">
                    <div class="stats-number text-2xl text-stack-blue">
                        {channels.length}
                    </div>
                    <div class="stats-label">Kênh</div>
                </div>
            </div>
            <div class="card">
                <div class="card-body text-center">
                    <div class="stats-number text-2xl text-stack-blue">
                        {
                            channels.reduce(
                                (total, channel) =>
                                    total + (channel.thread_count || 0),
                                0,
                            )
                        }
                    </div>
                    <div class="stats-label">Tổng Chủ Đề</div>
                </div>
            </div>
            <div class="card">
                <div class="card-body text-center">
                    <div class="stats-number text-2xl text-stack-blue">
                        {
                            Math.round(
                                channels.reduce(
                                    (total, channel) =>
                                        total + (channel.thread_count || 0),
                                    0,
                                ) / channels.length,
                            ) || 0
                        }
                    </div>
                    <div class="stats-label">Trung Bình/Kênh</div>
                </div>
            </div>
            <div class="card">
                <div class="card-body text-center">
                    <div class="stats-number text-2xl text-stack-blue">
                        Trực Tuyến
                    </div>
                    <div class="stats-label">Cộng Đồng</div>
                </div>
            </div>
        </div>

        <!-- Channels List -->
        <div class="space-y-4" data-pagefind-body>
            {
                channels.map((channel) => (
                    <article
                        class="card hover:shadow-md transition-shadow"
                        data-pagefind-meta={`title:${channel.name}`}
                        data-pagefind-meta="type:channel"
                        data-pagefind-meta={`threads:${channel.thread_count || 0}`}
                    >
                        <div class="card-body">
                            <div class="flex items-center justify-between">
                                <div class="flex-1">
                                    <h2
                                        class="text-xl font-semibold mb-2"
                                        data-pagefind-meta="title"
                                    >
                                        <a
                                            href={`/forum/${channel.slug}/`}
                                            class="hover:text-stack-blue transition-colors"
                                        >
                                            {channel.name}
                                        </a>
                                    </h2>

                                    {channel.description && (
                                        <p class="text-stack-gray-700 mb-4">
                                            {channel.description}
                                        </p>
                                    )}

                                    <div class="flex items-center space-x-4 text-sm text-stack-gray-600">
                                        <span class="flex items-center">
                                            <svg
                                                class="w-4 h-4 mr-1"
                                                fill="none"
                                                stroke="currentColor"
                                                viewBox="0 0 24 24"
                                            >
                                                <path
                                                    stroke-linecap="round"
                                                    stroke-linejoin="round"
                                                    stroke-width="2"
                                                    d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z"
                                                />
                                            </svg>
                                            {channel.thread_count || 0} chủ đề
                                        </span>

                                        <time
                                            datetime={channel.created_at.toISOString()}
                                            class="flex items-center"
                                        >
                                            <svg
                                                class="w-4 h-4 mr-1"
                                                fill="none"
                                                stroke="currentColor"
                                                viewBox="0 0 24 24"
                                            >
                                                <path
                                                    stroke-linecap="round"
                                                    stroke-linejoin="round"
                                                    stroke-width="2"
                                                    d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"
                                                />
                                            </svg>
                                            Tạo{" "}
                                            {new Intl.DateTimeFormat("vi-VN", {
                                                year: "numeric",
                                                month: "long",
                                                day: "numeric",
                                            }).format(channel.created_at)}
                                        </time>
                                    </div>
                                </div>

                                <div class="flex-shrink-0 ml-6">
                                    <a
                                        href={`/forum/${channel.slug}/`}
                                        class="btn-primary"
                                    >
                                        Duyệt Chủ Đề
                                    </a>
                                </div>
                            </div>
                        </div>
                    </article>
                ))
            }
        </div>

        {
            channels.length === 0 && (
                <div class="text-center py-12">
                    <svg
                        class="w-12 h-12 text-stack-gray-400 mx-auto mb-4"
                        fill="none"
                        stroke="currentColor"
                        viewBox="0 0 24 24"
                    >
                        <path
                            stroke-linecap="round"
                            stroke-linejoin="round"
                            stroke-width="2"
                            d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z"
                        />
                    </svg>
                    <h3 class="text-lg font-medium text-stack-gray-900 mb-2">
                        Không tìm thấy kênh nào
                    </h3>
                    <p class="text-stack-gray-600">
                        Hãy quay lại sau để xem các thảo luận cộng đồng.
                    </p>
                </div>
            )
        }
    </div>
</Layout>
