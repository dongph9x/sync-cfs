---
import Layout from "../../layouts/Layout.astro";
import { requireRole } from "../../lib/session";
import { createPool, getAllChannels, getThreadsByChannelId } from "../../lib/db";
import type { Channel, Thread } from "../../lib/db";
import EditorPanel from "../../components/EditorPanel.tsx";

// Require editor role
await requireRole(Astro, ['editor', 'admin']);

// Initialize database
createPool({
  host: import.meta.env.MYSQL_HOST || 'localhost',
  port: parseInt(import.meta.env.MYSQL_PORT || '3306'),
  user: import.meta.env.MYSQL_USER || 'root',
  password: import.meta.env.MYSQL_PASSWORD || '',
  database: import.meta.env.MYSQL_DATABASE || 'forum'
});

// Get all channels and their threads
const channels = await getAllChannels();
const channelThreads: { channel: Channel; threads: Thread[] }[] = [];

for (const channel of channels) {
  const threads = await getThreadsByChannelId(channel.id);
  channelThreads.push({
    channel: channel,
    threads: threads
  });
}

// SEO
const seo = {
  title: "Quản Trị - Editor",
  description: "Trang quản trị cho editor - Xem và chỉnh sửa threads",
  keywords: ["quản trị", "editor", "threads", "forum"],
  canonical: `${Astro.site}editor/`,
};
---

<Layout seo={seo}>
  <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
    <div class="mb-2">
      <h1 class="text-3xl font-bold text-gray-900">Quản Trị - Editor</h1>
      <p class="mt-2 text-gray-600">Xem và chỉnh sửa threads trong các kênh</p>
    </div>

    <EditorPanel client:load channels={channels} channelThreads={channelThreads} />
  </div>
</Layout>
