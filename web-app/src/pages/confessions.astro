---
import Layout from "../layouts/Layout.astro";
import TreeView, { TreeItem } from "../components/TreeView.tsx";
import {
    createPool,
    getThreadsByChannelSlug,
    getChannelBySlug,
    type Channel,
    type Thread,
} from "../lib/db";
import { generateStructuredData } from "../lib/seo";

// Initialize database connection
const dbConfig = {
    host: import.meta.env.MYSQL_HOST || "localhost",
    port: parseInt(import.meta.env.MYSQL_PORT || "3306"),
    user: import.meta.env.MYSQL_USER || "root",
    password: import.meta.env.MYSQL_PASSWORD || "password",
    database: import.meta.env.MYSQL_DATABASE || "forum",
};

createPool(dbConfig);

let channel: Channel | null = null;
let threads: Thread[] = [];
try {
    channel = await getChannelBySlug("confessions");
    if (channel) {
        threads = await getThreadsByChannelSlug("confessions");
    }
} catch (error) {
    console.error("Failed to fetch confessions data:", error);
}

// Convert threads to tree structure for TreeView
const treeItems: TreeItem[] = threads.map((thread: any) => ({
    id: thread.id,
    title: thread.title,
    type: 'thread' as const,
    thread: thread,
    isExpanded: false,
}));

// SEO
const seo = {
    title: "üìù Confessions - Forum",
    description: "N∆°i chia s·∫ª nh·ªØng c√¢u chuy·ªán, t√¢m s·ª± v√† confessions c·ªßa c·ªông ƒë·ªìng",
    keywords: ["confessions", "t√¢m s·ª±", "chia s·∫ª", "forum", "c·ªông ƒë·ªìng"],
    canonical: `${Astro.site}confessions/`,
};

// Generate structured data
const structuredData = generateStructuredData({
    type: "WebSite",
    name: "Confessions",
    url: "/confessions/",
    description: "N∆°i chia s·∫ª nh·ªØng c√¢u chuy·ªán, t√¢m s·ª± v√† confessions c·ªßa c·ªông ƒë·ªìng",
});
---

<Layout seo={seo}>
    <script type="application/ld+json" set:html={JSON.stringify(structuredData)} />
    
    <div class="max-w-6xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
        <!-- Page Header -->
        <div class="text-center mb-8">
            <h1 class="text-3xl font-bold text-gray-900 mb-4">
                Confessions
            </h1>
            <p class="text-lg text-gray-600 mb-6">
                Xem v√† s·∫Øp x·∫øp c√°c confessions theo √Ω th√≠ch c·ªßa b·∫°n. K√©o v√† th·∫£ ƒë·ªÉ thay ƒë·ªïi th·ª© t·ª± hi·ªÉn th·ªã.
            </p>
        </div>

        <!-- Tree View Container -->
        <div class="bg-gray-50 rounded-lg p-6">
            <div class="mb-4">
                <h2 class="text-xl font-semibold text-gray-900 mb-2">
                    Danh S√°ch Confessions
                </h2>
                <p class="text-sm text-gray-600">
                    K√©o v√† th·∫£ c√°c items ƒë·ªÉ s·∫Øp x·∫øp l·∫°i th·ª© t·ª± hi·ªÉn th·ªã
                </p>
            </div>

            <div class="space-y-4">
                {threads.length > 0 ? (
                    <TreeView client:only="react" items={treeItems} channelSlug="confessions" />
                ) : (
                    <div class="text-center py-12">
                        <p class="text-gray-500 text-lg">Ch∆∞a c√≥ confessions n√†o ƒë∆∞·ª£c ƒëƒÉng.</p>
                        <p class="text-gray-500 text-sm mt-2">H√£y l√† ng∆∞·ªùi ƒë·∫ßu ti√™n chia s·∫ª!</p>
                    </div>
                )}
            </div>
        </div>
    </div>
</Layout>
