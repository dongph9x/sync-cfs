---
import "../styles/global.css";
import PromoBanner from "../components/PromoBanner.astro";
import {
    getBannerConfig,
    shouldShowBanner,
    generateBannerScript,
} from "../lib/promo";
import { generateStructuredData, type SEOData } from "../lib/seo";
import { getSessionUser } from "../lib/session";

interface Props {
    seo?: SEOData;
    showBanner?: boolean;
    pageIndex?: number;
}

const { seo: seoProp, showBanner = false, pageIndex = 0 } = Astro.props;

// Provide default SEO data if not provided
const seo = seoProp || {
    title: "Ani Nhi Confessions",
    description: "Diễn đàn cộng đồng Ani Nhi Confessions",
    keywords: ["discord", "diễn đàn", "cộng đồng", "thảo luận"],
    canonical: Astro.url.toString(),
    ogType: "website"
};
const bannerConfig = getBannerConfig();
const shouldDisplayBanner =
    showBanner || shouldShowBanner(pageIndex, bannerConfig);

// Get current user
const user = await getSessionUser(Astro);

const websiteSchema = generateStructuredData({
    type: "WebSite",
    name: "Ani Nhi Confessions",
    url: Astro.site?.toString(),
    description: seo.description || "Diễn đàn cộng đồng Ani Nhi Confessions",
});
---

<!doctype html>
<html lang="vi">
    <head>
        <meta charset="UTF-8" />
        <meta name="description" content={seo.description || "Diễn đàn cộng đồng Ani Nhi Confessions"} />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <link rel="icon" type="image/svg+xml" href="/favicon.png" />
        <meta name="generator" content={Astro.generator} />

        <!-- SEO Meta -->
        <title>{seo.title}</title>
        {
            seo.keywords && (
                <meta name="keywords" content={seo.keywords.join(", ")} />
            )
        }
        {seo.canonical && <link rel="canonical" href={seo.canonical} />}

        <!-- Open Graph -->
        <meta property="og:title" content={seo.title} />
        <meta property="og:description" content={seo.description || "Diễn đàn cộng đồng Ani Nhi Confessions"} />
        <meta property="og:type" content={seo.ogType || "website"} />
        <meta
            property="og:url"
            content={seo.canonical || Astro.url.toString()}
        />
        {seo.ogImage && <meta property="og:image" content={seo.ogImage} />}

        <!-- Twitter Card -->
        <meta name="twitter:card" content="summary" />
        <meta name="twitter:title" content={seo.title} />
        <meta name="twitter:description" content={seo.description || "Diễn đàn cộng đồng Ani Nhi Confessions"} />
        {seo.ogImage && <meta name="twitter:image" content={seo.ogImage} />}

        <!-- JSON-LD Structured Data -->
        <script
            type="application/ld+json"
            set:html={JSON.stringify(websiteSchema)}
        />
    </head>
    <body>
        <!-- Promotional Banner -->
        {
            shouldDisplayBanner && (
                <PromoBanner
                    discordInviteUrl={bannerConfig.discordInviteUrl}
                    message={bannerConfig.message}
                />
            )
        }

        <!-- Header -->
        <header
            class="bg-white border-b border-stack-gray-200 sticky top-0 z-40"
        >
            <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
                <div class="flex justify-between items-center h-16">
                    <div class="flex items-center">
                        <a
                            href="/"
                            class="text-xl font-bold text-stack-gray-900"
                        >
                            Ani Nhi Confessions
                        </a>
                    </div>

                    <nav class="flex items-center space-x-6">
                        {user && <a
                            href="/dashboard"
                            class="text-stack-gray-700 hover:text-stack-gray-900 transition-colors"
                        >
                            Dashboard
                        </a>}
                        {user && user.role === 'editor' && (
                            <a
                                href="/editor"
                                class="text-stack-gray-700 hover:text-stack-gray-900 transition-colors"
                            >
                                Quản lý confessions
                            </a>
                        )}
                        {user && user.role === 'viewer' && (
                            <a
                                href="/viewer"
                                class="text-stack-gray-700 hover:text-stack-gray-900 transition-colors"
                            >
                                Xem confessions
                            </a>
                        )}
                        <a
                            href="/forum/"
                            class="text-stack-gray-700 hover:text-stack-gray-900 transition-colors"
                        >
                            Diễn Đàn
                        </a>
                        <a
                            href="/search/"
                            class="text-stack-gray-700 hover:text-stack-gray-900 transition-colors inline-flex items-center"
                        >
                            <svg
                                class="w-4 h-4 mr-1"
                                fill="none"
                                stroke="currentColor"
                                viewBox="0 0 24 24"
                            >
                                <path
                                    stroke-linecap="round"
                                    stroke-linejoin="round"
                                    stroke-width="2"
                                    d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"
                                ></path>
                            </svg>
                            Tìm Kiếm
                        </a>
                        
                        {!user &&
                            <a
                                href={bannerConfig.discordInviteUrl}
                                target="_blank"
                                rel="noopener noreferrer"
                                class="btn-primary"
                            >
                                Tham Gia Discord
                            </a>
                            <a
                                href="/login"
                                class="btn-primary"
                            >
                                Đăng nhập
                            </a>
                        }
                    </nav>
                </div>
            </div>
        </header>

        <!-- Main Content -->
        <main class="min-h-screen bg-stack-gray-50">
            <slot />
        </main>

        <!-- Footer -->
        <footer class="bg-white border-t border-stack-gray-200">
            <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-12">
                <div class="grid grid-cols-1 md:grid-cols-3 gap-8">
                    <div>
                        <h3 class="text-lg font-semibold mb-4">
                            Ani Nhi Confessions
                        </h3>
                        <p class="text-stack-gray-600">
                            Thảo luận cộng đồng được lưu trữ từ máy chủ Discord của chúng tôi.
                        </p>
                    </div>

                    <div>
                        <h4 class="font-semibold mb-4">Liên Kết Nhanh</h4>
                        <ul class="space-y-2 text-stack-gray-600">
                            <li>
                                <a
                                    href="/forum/"
                                    class="hover:text-stack-gray-900"
                                    >Trang Chủ Diễn Đàn</a
                                >
                            </li>
                            <li>
                                <a
                                    href={bannerConfig.discordInviteUrl}
                                    target="_blank"
                                    rel="noopener noreferrer"
                                    class="hover:text-stack-gray-900"
                                    >Tham Gia Discord</a
                                >
                            </li>
                        </ul>
                    </div>

                    <div>
                        <h4 class="font-semibold mb-4">Cộng Đồng</h4>
                        <p class="text-stack-gray-600 text-sm">
                            Diễn đàn này là kho lưu trữ tĩnh các thảo luận từ máy chủ Discord của chúng tôi. Tham gia cộng đồng trực tuyến để có những cuộc trò chuyện thời gian thực!
                        </p>
                    </div>
                </div>
            </div>
        </footer>

        <script is:inline set:html={generateBannerScript()}></script>
    </body>
</html>
